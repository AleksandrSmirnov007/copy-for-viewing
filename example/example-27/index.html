<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Геометрия: Мобильный Тренажер</title>
    <style>
        :root {
            --primary: #2c3e50; --accent: #3498db; --success: #27ae60;
            --danger: #e74c3c; --bisector: #9b59b6; --height: #e67e22;
            --median: #2ecc71; --gold: #f1c40f; --bg: #f0f2f5;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg); margin: 0; padding: 10px;
            display: flex; justify-content: center; align-items: flex-start; min-height: 100vh;
        }

        .main-app { 
            background: white; width: 100%; max-width: 950px; 
            border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            display: flex; flex-direction: row; overflow: hidden; position: relative; 
            min-height: 600px;
        }

        /* Адаптивность: переключаем в колонку на мобилках */
        @media (max-width: 800px) {
            .main-app { flex-direction: column; height: auto; min-height: unset; }
            .content-panel { width: 100% !important; padding: 20px !important; }
            .visual-panel { height: 300px; padding: 10px !important; }
            svg { height: 250px !important; }
        }

        /* Левая панель: Визуализация */
        .visual-panel { 
            flex: 1; background: white; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; border-right: 2px solid #f0f0f0; 
            padding: 20px;
        }

        svg { width: 100%; height: 350px; overflow: visible; }
        .tri-base { fill: rgba(52, 152, 219, 0.05); stroke: var(--primary); stroke-width: 3; }
        .marker { stroke-width: 4; fill: none; opacity: 0; transition: 0.3s; stroke-linecap: round; }
        .label { font-weight: bold; font-size: 18px; fill: var(--primary); }

        /* Правая панель: Контент */
        .content-panel { 
            width: 380px; padding: 30px; display: flex; flex-direction: column; 
            background: #fafbfc; justify-content: space-between;
        }

        .progress-bar { height: 8px; background: #eee; border-radius: 4px; margin-bottom: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: 0.4s; }
        
        h2 { margin: 0 0 10px 0; color: var(--primary); font-size: 20px; }
        .step-desc { font-size: 15px; color: #555; line-height: 1.4; margin-bottom: 15px; }
        
        .opt-btn { 
            width: 100%; padding: 15px; margin-bottom: 8px; border: 2px solid #eee; 
            border-radius: 10px; background: white; cursor: pointer; transition: 0.2s; 
            font-size: 15px; font-weight: 500; color: var(--primary);
        }
        .opt-btn:active { transform: scale(0.98); background: #f0f7ff; }
        .opt-btn.correct { background: var(--success) !important; color: white; border-color: var(--success); }
        .opt-btn.wrong { background: var(--danger) !important; color: white; border-color: var(--danger); }

        .nav-btns { display: flex; gap: 10px; margin-top: 20px; }
        .nav-btn { 
            flex: 1; padding: 14px; border: none; border-radius: 10px; 
            cursor: pointer; font-weight: bold; font-size: 14px; 
        }
        .btn-next { background: var(--primary); color: white; }
        .btn-prev { background: #e0e0e0; color: #555; }
        .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        /* Слой Босса */
        #boss-layer { 
            position: absolute; inset: 0; background: white; z-index: 100; 
            display: none; flex-direction: column; align-items: center; 
            padding: 20px; text-align: center; overflow-y: auto;
        }
        .boss-svg-box { width: 100%; height: 250px; background: #f9f9f9; border-radius: 15px; margin: 15px 0; border: 3px solid transparent; }
        
        .boss-btn-grid { 
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; width: 100%; 
            margin-bottom: 20px;
        }

        .leaderboard { width: 100%; margin-top: 15px; font-size: 14px; }
        .leaderboard td { padding: 8px; border-bottom: 1px solid #f0f0f0; }
    </style>
</head>
<body>

<div class="main-app">
    <div class="visual-panel" id="vPanel">
        <svg viewBox="0 0 400 350" id="mainSvg">
            <path id="triPath" class="tri-base" d="M200,50 L80,300 L320,300 Z" />
            <line id="mSideL" class="marker" x1="130" y1="160" x2="150" y2="180" stroke="var(--danger)" />
            <line id="mSideR" class="marker" x1="250" y1="180" x2="270" y2="160" stroke="var(--danger)" />
            <path id="mAngleA" class="marker" d="M110,300 A30,30 0 0 0 100,275" stroke="var(--height)" />
            <path id="mAngleC" class="marker" d="M300,275 A30,30 0 0 0 290,300" stroke="var(--height)" />
            <line id="mCenter" class="marker" x1="200" y1="50" x2="200" y2="300" stroke="#7f8c8d" stroke-dasharray="5,5" />
            <polyline id="mSquare" class="marker" points="180,300 180,280 200,280" stroke="var(--height)" />
            <text x="190" y="40" class="label">B</text>
            <text x="50" y="320" class="label">A</text>
            <text x="330" y="320" class="label">C</text>
        </svg>
    </div>

    <div class="content-panel">
        <div>
            <div class="progress-bar"><div class="progress-fill" id="pFill"></div></div>
            <h2 id="stepTitle">Загрузка...</h2>
            <p id="stepDesc" class="step-desc"></p>
            <div id="stepInput"></div>
        </div>

        <div class="nav-btns">
            <button class="nav-btn btn-prev" id="btnBack" onclick="moveStep(-1)">Назад</button>
            <button class="nav-btn btn-next" id="btnNext" onclick="moveStep(1)">Далее</button>
        </div>
    </div>

    <div id="boss-layer">
        <h2 id="bossStatus">СПРИНТ: БОСС</h2>
        <div style="display: flex; gap: 20px; font-weight: bold; margin-bottom: 10px;">
            <span id="bossScore">Очки: 0</span>
            <span id="bossTimer">00:30</span>
        </div>
        <div class="boss-svg-box" id="bossBox"><svg id="bossSvg" viewBox="0 0 400 300"></svg></div>
        
        <div id="bossControls" class="boss-btn-grid" style="display:none;">
            <button class="nav-btn" style="background:var(--bisector); color:white" onclick="checkBoss('bis')">БИСС</button>
            <button class="nav-btn" style="background:var(--height); color:white" onclick="checkBoss('hei')">ВЫСОТ</button>
            <button class="nav-btn" style="background:var(--median); color:white" onclick="checkBoss('med')">МЕДИ</button>
        </div>

        <div id="bossStartUI">
            <button class="nav-btn btn-next" style="padding: 15px 40px;" onclick="startBoss()">НАЧАТЬ ТЕСТ</button>
            <table class="leaderboard"><tbody id="leaderboardBody"></tbody></table>
        </div>
    </div>
</div>

<script>
    const steps = [
        { t: "Равные стороны", d: "В равнобедренном треугольнике две стороны равны. Они называются боковыми.", opts: ["AB = BC"], act: () => show(['mSideL', 'mSideR']) },
        { t: "Углы при основании", d: "Углы при основании (A и C) всегда равны.", q: "∠A = 55°. Чему равен ∠C?", opts: ["55°", "110°"], corr: "55°", act: () => show(['mAngleA', 'mAngleC']) },
        { t: "Сумма углов", d: "Сумма всех углов всегда 180°. Если ∠A=50° и ∠C=50°...", q: "Чему равен угол при вершине B?", opts: ["80°", "100°"], corr: "80°" },
        { t: "Медиана к основанию", d: "Медиана делит основание ровно пополам.", q: "Если AC=10, чему равен отрезок AM?", opts: ["5", "10"], corr: "5", act: () => show(['mCenter']) },
        { t: "Высота", d: "Высота падает на основание под углом 90°.", opts: ["Понятно"], act: () => show(['mCenter', 'mSquare']) },
        { t: "Свойство 3 в 1", d: "Высота, медиана и биссектриса к основанию - это ОДНА ЛИНИЯ.", opts: ["Запомнил!"], act: () => show(['mCenter', 'mSquare', 'mAngleA', 'mAngleC']) },
        { t: "Боковая сторона", d: "Периметр 22, основание 2. Найти боковую сторону.", opts: ["10", "20"], corr: "10" },
        { t: "Прямой угол", d: "Может ли быть угол при основании 90°?", opts: ["Нет", "Да"], corr: "Нет" },
        { t: "Внешний угол", d: "Внешний угол 140°. Найди внутренний угол при основании.", opts: ["40°", "140°"], corr: "40°" },
        { t: "Равносторонний", d: "Если все стороны равны, какой угол в треугольнике?", opts: ["60°", "90°"], corr: "60°" },
        { t: "Периметр 2", d: "Боковая сторона 7, основание 10. Чему равен Периметр?", opts: ["24", "17"], corr: "24" },
        { t: "Биссектриса 2", d: "Биссектриса угла B разделила его на два угла по 25°.", q: "Чему равен весь угол B?", opts: ["50°", "25°"], corr: "50°" },
        { t: "Ось симметрии", d: "Сколько осей симметрии у равнобедренного треугольника?", opts: ["1", "3"], corr: "1" },
        { t: "Основание", d: "Боковая сторона 8, Периметр 20. Чему равно основание?", opts: ["4", "12"], corr: "4" },
        { t: "Тупоугольный", d: "Угол при вершине 120°. Найди угол при основании.", opts: ["30°", "60°"], corr: "30°" },
        { t: "Медиана 2", d: "Если медиана равна 5 см, а высота к основанию...?", opts: ["Она тоже 5 см"], corr: "Она тоже 5 см" },
        { t: "Признак", d: "Если углы равны 40°, 100°, 40°. Он равнобедренный?", opts: ["Да", "Нет"], corr: "Да" },
        { t: "Биссектрисы сторон", d: "Биссектрисы боковых сторон всегда равны между собой.", opts: ["ОК"], act: () => show(['mSideL', 'mSideR']) },
        { t: "Прямоугольный", d: "Угол при вершине 90°. Углы при основании?", opts: ["45° и 45°", "60° и 30°"], corr: "45° и 45°" },
        { t: "Финал", d: "Ты готов к финальному тесту на скорость?", opts: ["ПОЕХАЛИ!"], act: () => { document.getElementById('boss-layer').style.display='flex'; updateLeaderboard(); } }
    ];

    let currentStep = 0;
    function moveStep(dir) {
        if (currentStep + dir >= 0 && currentStep + dir < steps.length) {
            currentStep += dir; renderStep();
        }
    }

    function renderStep() {
        const s = steps[currentStep];
        document.getElementById('stepTitle').innerText = s.t;
        document.getElementById('stepDesc').innerHTML = s.d;
        document.getElementById('pFill').style.width = `${((currentStep+1)/steps.length)*100}%`;
        
        const ctrl = document.getElementById('stepInput');
        ctrl.innerHTML = '';
        hideAll();
        if (s.act) s.act();

        s.opts.forEach(o => {
            const b = document.createElement('button');
            b.className = 'opt-btn';
            b.innerText = o;
            b.onclick = () => {
                if (s.corr) {
                    if (o === s.corr) { b.classList.add('correct'); setTimeout(() => moveStep(1), 500); }
                    else { b.classList.add('wrong'); }
                } else moveStep(1);
            };
            ctrl.appendChild(b);
        });
        document.getElementById('btnBack').disabled = currentStep === 0;
    }

    function show(ids) { ids.forEach(id => document.getElementById(id).style.opacity = 1); }
    function hideAll() { ['mSideL','mSideR','mAngleA','mAngleC','mCenter','mSquare'].forEach(id => document.getElementById(id).style.opacity = 0); }

    // --- БОСС ---
    let bScore = 0, bTime = 30, bGoal = '', bInt;

    function startBoss() {
        bScore = 0; bTime = 30;
        document.getElementById('bossStartUI').style.display = 'none';
        document.getElementById('bossControls').style.display = 'grid';
        nextBossQ();
        bInt = setInterval(() => {
            bTime--; document.getElementById('bossTimer').innerText = `00:${bTime<10?'0':''}${bTime}`;
            if (bTime <= 0) endBoss();
        }, 1000);
    }

    function nextBossQ() {
        const ts = ['bis', 'hei', 'med']; bGoal = ts[Math.floor(Math.random()*3)];
        const svg = document.getElementById('bossSvg');
        const cX = 200, cY = 250, tY = 80;
        let mk = '';
        if (bGoal==='bis') mk = `<path d="M190,100 A15,15 0 0 1 200,100 M200,100 A15,15 0 0 1 210,100" stroke="var(--bisector)" fill="none" stroke-width="4"/>`;
        else if (bGoal==='hei') mk = `<polyline points="180,250 180,230 200,230" stroke="var(--height)" fill="none" stroke-width="4"/>`;
        else mk = `<line x1="130" y1="240" x2="135" y2="260" stroke="var(--median)" stroke-width="4"/><line x1="265" y1="240" x2="270" y2="260" stroke="var(--median)" stroke-width="4"/>`;
        
        svg.innerHTML = `<path d="M200,${tY} L80,250 L320,250 Z" fill="#3498db11" stroke="#2c3e50" stroke-width="3"/>
                        <line x1="200" y1="${tY}" x2="200" y2="250" stroke="#7f8c8d" stroke-dasharray="5,5" stroke-width="2"/>${mk}`;
    }

    function checkBoss(a) {
        if (a === bGoal) { bScore += 10; document.getElementById('bossBox').style.borderColor = 'var(--success)'; }
        else { bTime = Math.max(0, bTime - 3); document.getElementById('bossBox').style.borderColor = 'var(--danger)'; }
        document.getElementById('bossScore').innerText = `Очки: ${bScore}`;
        setTimeout(() => { document.getElementById('bossBox').style.borderColor = 'transparent'; nextBossQ(); }, 200);
    }

    function endBoss() {
        clearInterval(bInt);
        let h = JSON.parse(localStorage.getItem('geoRes') || '[]');
        h.push({s: bScore, d: new Date().toLocaleDateString()});
        h.sort((a,b) => b.s - a.s);
        localStorage.setItem('geoRes', JSON.stringify(h.slice(0,5)));
        document.getElementById('bossStatus').innerText = "РЕЗУЛЬТАТ: " + bScore;
        document.getElementById('bossControls').style.display = 'none';
        document.getElementById('bossStartUI').style.display = 'block';
        updateLeaderboard();
    }

    function updateLeaderboard() {
        const h = JSON.parse(localStorage.getItem('geoRes') || '[]');
        document.getElementById('leaderboardBody').innerHTML = h.map((x,i) => `<tr><td>#${i+1}</td><td><b>${x.s}</b></td><td>${x.d}</td></tr>`).join('');
    }

    renderStep();
</script>
</body>
</html>
