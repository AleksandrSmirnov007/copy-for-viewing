<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Геометрический Спринт с Рекордами</title>
    <style>
        /* ... (предыдущие стили остаются) ... */
        
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --bisector: #9b59b6;
            --height: #e67e22;
            --median: #2ecc71;
            --gold: #f1c40f;
        }

        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        
        .game-card { background: white; width: 600px; padding: 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); text-align: center; position: relative; }
        
        .stats-bar { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold; font-size: 1.2em; }
        
        #timer { color: var(--danger); min-width: 100px; text-align: right; }
        #score { color: var(--success); }

        .svg-container { background: #f9f9f9; border-radius: 15px; margin-bottom: 20px; position: relative; height: 300px; border: 2px solid transparent; transition: 0.2s; }
        svg { width: 100%; height: 100%; }

        .btn-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        
        .game-btn { 
            padding: 15px; border: none; border-radius: 10px; cursor: pointer; 
            font-weight: bold; color: white; transition: 0.2s; font-size: 14px;
        }
        .btn-b { background: var(--bisector); }
        .btn-h { background: var(--height); }
        .btn-m { background: var(--median); }

        /* Экран старта и финиша */
        #overlay-screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.95); display: flex; flex-direction: column; 
            justify-content: center; align-items: center; border-radius: 15px; z-index: 10; 
        }
        
        /* Таблица рекордов */
        .leaderboard {
            margin-top: 15px;
            width: 80%;
            border-collapse: collapse;
        }
        .leaderboard th { color: #7f8c8d; font-size: 0.8em; text-transform: uppercase; padding-bottom: 5px; }
        .leaderboard td { padding: 5px; border-bottom: 1px solid #eee; font-weight: bold; }
        .leaderboard tr:first-child td { color: var(--gold); font-size: 1.2em; }

        .pulse { animation: pulse-animation 2s infinite; }
        @keyframes pulse-animation { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .shape { fill: rgba(52, 152, 219, 0.05); stroke: var(--primary); stroke-width: 2; }
        .line-active { stroke: #7f8c8d; stroke-width: 2; stroke-dasharray: 4; }
        .marker { stroke-width: 3; fill: none; stroke-linecap: round; }
    </style>
</head>
<body>

<div class="game-card">
    <div class="stats-bar">
        <span>Счет: <span id="scoreVal">0</span></span>
        <span id="timer">Время: 30</span>
    </div>

    <div class="svg-container" id="svgBox">
        <div id="overlay-screen">
            <h2 id="screenTitle">Геометрический Спринт</h2>
            <p id="screenDesc">Определи тип линии за 30 секунд!</p>
            
            <table class="leaderboard" id="leaderboard" style="display: none;">
                <thead><tr><th>Место</th><th>Очки</th><th>Дата</th></tr></thead>
                <tbody id="leaderboardBody"></tbody>
            </table>

            <button class="game-btn btn-b pulse" id="actionBtn" onclick="startGame()" style="padding: 15px 40px; font-size: 18px; margin-top: 20px;">ИГРАТЬ</button>
        </div>
        
        <svg id="gameSvg" viewBox="0 0 400 300">
            <path id="tri" class="shape" d="" />
            <line id="centralLine" class="line-active" x1="0" y1="0" x2="0" y2="0" />
            <g id="markersGroup"></g>
        </svg>
    </div>

    <div class="btn-grid">
        <button class="game-btn btn-b" onclick="checkAnswer('bisector')">БИССЕКТРИСА</button>
        <button class="game-btn btn-h" onclick="checkAnswer('height')">ВЫСОТА</button>
        <button class="game-btn btn-m" onclick="checkAnswer('median')">МЕДИАНА</button>
    </div>
</div>

<script>
    let score = 0;
    let timeLeft = 30;
    let gameActive = false;
    let currentType = '';
    let timerId;

    const types = ['bisector', 'height', 'median'];

    // Загрузка рекордов при старте
    window.onload = updateLeaderboardDisplay;

    function startGame() {
        score = 0;
        timeLeft = 30;
        gameActive = true;
        document.getElementById('overlay-screen').style.display = 'none';
        document.getElementById('scoreVal').textContent = score;
        nextQuestion();
        
        timerId = setInterval(() => {
            timeLeft--;
            document.getElementById('timer').textContent = `Время: ${timeLeft}`;
            if (timeLeft <= 0) endGame();
        }, 1000);
    }

    function nextQuestion() {
        currentType = types[Math.floor(Math.random() * types.length)];
        drawTriangle();
    }

    function drawTriangle() {
        const markers = document.getElementById('markersGroup');
        markers.innerHTML = '';
        
        const baseWidth = 120 + Math.random() * 180;
        const height = 80 + Math.random() * 120;
        const centerX = 200;
        const centerY = 250;
        const topY = centerY - height;
        const xA = centerX - baseWidth/2;
        const xC = centerX + baseWidth/2;

        document.getElementById('tri').setAttribute('d', `M${centerX},${topY} L${xA},${centerY} L${xC},${centerY} Z`);
        document.getElementById('centralLine').setAttribute('x1', centerX);
        document.getElementById('centralLine').setAttribute('y1', topY);
        document.getElementById('centralLine').setAttribute('x2', centerX);
        document.getElementById('centralLine').setAttribute('y2', centerY);

        if (currentType === 'bisector') {
            markers.innerHTML = `
                <path class="marker" d="M${centerX-12},${topY+25} A18,18 0 0 1 ${centerX},${topY+25}" stroke="var(--bisector)"/>
                <path class="marker" d="M${centerX},${topY+25} A18,18 0 0 1 ${centerX+12},${topY+25}" stroke="var(--bisector)"/>
            `;
        } else if (currentType === 'height') {
            markers.innerHTML = `<polyline class="marker" points="${centerX-15},${centerY} ${centerX-15},${centerY-15} ${centerX},${centerY-15}" stroke="var(--height)"/>`;
        } else if (currentType === 'median') {
            const m1X = (xA + centerX) / 2;
            const m2X = (xC + centerX) / 2;
            markers.innerHTML = `
                <line class="marker" x1="${m1X-3}" y1="${centerY-8}" x2="${m1X+3}" y2="${centerY+8}" stroke="var(--median)"/>
                <line class="marker" x1="${m2X-3}" y1="${centerY-8}" x2="${m2X+3}" y2="${centerY+8}" stroke="var(--median)"/>
            `;
        }
    }

    function checkAnswer(choice) {
        if (!gameActive) return;
        const box = document.getElementById('svgBox');

        if (choice === currentType) {
            score += 10;
            document.getElementById('scoreVal').textContent = score;
            box.style.borderColor = 'var(--success)';
        } else {
            timeLeft = Math.max(0, timeLeft - 3);
            box.style.borderColor = 'var(--danger)';
        }
        
        setTimeout(() => {
            box.style.borderColor = 'transparent';
            if (gameActive) nextQuestion();
        }, 150);
    }

    function saveScore(newScore) {
        let history = JSON.parse(localStorage.getItem('geoScores') || '[]');
        const entry = {
            score: newScore,
            date: new Date().toLocaleDateString('ru-RU', {day: '2-digit', month: '2-digit'})
        };
        history.push(entry);
        history.sort((a, b) => b.score - a.score);
        history = history.slice(0, 5); // Только ТОП-5
        localStorage.setItem('geoScores', JSON.stringify(history));
    }

    function updateLeaderboardDisplay() {
        const history = JSON.parse(localStorage.getItem('geoScores') || '[]');
        const body = document.getElementById('leaderboardBody');
        const table = document.getElementById('leaderboard');
        
        if (history.length > 0) {
            table.style.display = 'table';
            body.innerHTML = history.map((item, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${item.score}</td>
                    <td>${item.date}</td>
                </tr>
            `).join('');
        }
    }

    function endGame() {
        gameActive = false;
        clearInterval(timerId);
        saveScore(score);
        
        const screen = document.getElementById('overlay-screen');
        const title = document.getElementById('screenTitle');
        const desc = document.getElementById('screenDesc');
        
        title.innerHTML = "ФИНИШ!";
        desc.innerHTML = `Твой результат: <b style="color:var(--success); font-size: 1.5em;">${score}</b>`;
        
        updateLeaderboardDisplay();
        screen.style.display = 'flex';
        document.getElementById('actionBtn').innerText = "ИГРАТЬ СНОВА";
    }
</script>

</body>
</html>
